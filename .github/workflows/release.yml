name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  release:
    types: [published]  # Triggers when publishing a draft from release-drafter
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create new release'
        required: true
        type: boolean
        default: false
      pre_release_tag:
        description: 'Pre-release tag (e.g., rc1, beta1)'
        required: false
        type: string
        default: ''

concurrency:
  group: release
  cancel-in-progress: false  # Don't cancel releases

env:
  CMAKE_BUILD_PARALLEL_LEVEL: 4

jobs:
  # ---------------------------------------------------------------------------
  # Determine version/tag
  # ---------------------------------------------------------------------------
  determine-tag:
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.tag.outputs.name }}
      should_release: ${{ steps.tag.outputs.should_release }}
      is_prerelease: ${{ steps.tag.outputs.is_prerelease }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine tag name
        id: tag
        run: |
          BUILD_NUMBER=$(git rev-list --count HEAD)
          SHORT_HASH=$(git rev-parse --short=7 HEAD)
          CUSTOM_TAG="${{ github.event.inputs.pre_release_tag }}"
          SHOULD_RELEASE="false"
          IS_PRERELEASE="false"

          # Triggered by publishing a release (from release-drafter)
          if [[ "${{ github.event_name }}" == "release" ]]; then
            TAG_NAME="${{ github.event.release.tag_name }}"
            SHOULD_RELEASE="true"
            if [[ "${{ github.event.release.prerelease }}" == "true" ]]; then
              IS_PRERELEASE="true"
            fi
          # Triggered by pushing a tag
          elif [[ "${{ github.ref_type }}" == "tag" ]]; then
            TAG_NAME="${{ github.ref_name }}"
            SHOULD_RELEASE="true"
            if [[ "$TAG_NAME" =~ (rc|alpha|beta) ]]; then
              IS_PRERELEASE="true"
            fi
          # Manual trigger with custom pre-release tag
          elif [[ -n "$CUSTOM_TAG" ]]; then
            TAG_NAME="v0.0.0-${CUSTOM_TAG}"
            SHOULD_RELEASE="true"
            IS_PRERELEASE="true"
          # Manual trigger to create release
          elif [[ "${{ github.event.inputs.create_release }}" == "true" ]]; then
            TAG_NAME="b${BUILD_NUMBER}"
            SHOULD_RELEASE="true"
          # Manual trigger without release (just build)
          else
            TAG_NAME="dev-b${BUILD_NUMBER}-${SHORT_HASH}"
            SHOULD_RELEASE="false"
          fi

          echo "Event: ${{ github.event_name }}"
          echo "Tag: $TAG_NAME, Release: $SHOULD_RELEASE, Pre-release: $IS_PRERELEASE"
          echo "name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "should_release=$SHOULD_RELEASE" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT

  # ---------------------------------------------------------------------------
  # Build release artifacts
  # ---------------------------------------------------------------------------
  build-artifacts:
    name: Build (${{ matrix.platform }}-${{ matrix.arch }})
    needs: determine-tag
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            platform: linux
            arch: x86_64
          - os: macos-14
            platform: macos
            arch: arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: release-${{ matrix.platform }}-${{ matrix.arch }}
          evict-old-files: 1d

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build cmake

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install ninja cmake

      - name: Configure
        run: |
          cmake --preset dev-release \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

      - name: Build
        run: cmake --build build/dev-release --parallel

      - name: Run tests
        run: ctest --test-dir build/dev-release --output-on-failure

      - name: Prepare release package
        id: package
        run: |
          VERSION="${{ needs.determine-tag.outputs.tag_name }}"
          PACKAGE_NAME="logoslab-${VERSION}-${{ matrix.platform }}-${{ matrix.arch }}"

          mkdir -p "${PACKAGE_NAME}/bin"
          mkdir -p "${PACKAGE_NAME}/lib"
          mkdir -p "${PACKAGE_NAME}/include"

          # Copy executable
          cp build/dev-release/main "${PACKAGE_NAME}/bin/"

          # Copy library
          cp build/dev-release/libLogosLabLib.a "${PACKAGE_NAME}/lib/"

          # Copy headers
          cp -r include/* "${PACKAGE_NAME}/include/"

          # Copy documentation
          cp README.md LICENSE "${PACKAGE_NAME}/"

          # Create tarball
          tar -czf "${PACKAGE_NAME}.tar.gz" "${PACKAGE_NAME}"

          echo "package_name=${PACKAGE_NAME}" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ steps.package.outputs.package_name }}
          path: ${{ steps.package.outputs.package_name }}.tar.gz
          retention-days: 7

  # ---------------------------------------------------------------------------
  # Upload assets to GitHub Release
  # ---------------------------------------------------------------------------
  upload-release-assets:
    name: Upload Release Assets
    needs: [determine-tag, build-artifacts]
    if: needs.determine-tag.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: List artifacts
        run: ls -R artifacts

      - name: Upload assets to existing release (from release-drafter)
        if: github.event_name == 'release'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.determine-tag.outputs.tag_name }}
        run: |
          # Upload binaries to the existing release
          gh release upload "${VERSION}" artifacts/*/*.tar.gz --clobber

      - name: Create new release (from tag push or manual)
        if: github.event_name != 'release'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.determine-tag.outputs.tag_name }}
          IS_PRERELEASE: ${{ needs.determine-tag.outputs.is_prerelease }}
        run: |
          # Generate release notes
          cat > release-notes.md << EOF
          ## LogosLab ${VERSION}

          ### Downloads
          | Platform | Architecture | Download |
          |----------|--------------|----------|
          | Linux | x86_64 | \`logoslab-${VERSION}-linux-x86_64.tar.gz\` |
          | macOS | ARM64 | \`logoslab-${VERSION}-macos-arm64.tar.gz\` |

          ### Installation
          \`\`\`bash
          tar -xzf logoslab-${VERSION}-<platform>-<arch>.tar.gz
          cd logoslab-${VERSION}-*/bin/
          ./main
          \`\`\`

          ### Package Contents
          - \`bin/main\` - Main executable
          - \`lib/libLogosLabLib.a\` - Static library
          - \`include/\` - Header files
          EOF

          # Determine release flags
          RELEASE_FLAGS=""
          if [[ "$IS_PRERELEASE" == "true" ]]; then
            RELEASE_FLAGS="--prerelease"
          fi

          # Create release
          gh release create "${VERSION}" \
            --title "LogosLab ${VERSION}" \
            --notes-file release-notes.md \
            $RELEASE_FLAGS \
            artifacts/*/*.tar.gz