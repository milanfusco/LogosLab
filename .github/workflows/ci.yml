name: CI

on:
  push:
    branches: [main]
    paths:
      - '.github/workflows/ci.yml'
      - '**/CMakeLists.txt'
      - 'CMakePresets.json'
      - '**/*.h'
      - '**/*.hpp'
      - '**/*.c'
      - '**/*.cpp'
      - '**/*.in'
      - '**/*.cmake'
  pull_request:
    branches: [main]
    paths:
      - '.github/workflows/ci.yml'
      - '**/CMakeLists.txt'
      - 'CMakePresets.json'
      - '**/*.h'
      - '**/*.hpp'
      - '**/*.c'
      - '**/*.cpp'
      - '**/*.in'
      - '**/*.cmake'
  workflow_dispatch:
    inputs:
      run_type:
        description: 'CI scope'
        required: true
        default: 'standard'
        type: choice
        options:
          - standard
          - full
          - sanitizers-only

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  CMAKE_BUILD_PARALLEL_LEVEL: 4

jobs:
  # ---------------------------------------------------------------------------
  # Build & Test - Native runners
  # ---------------------------------------------------------------------------
  build-and-test:
    name: Build & Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, macos-14]

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ matrix.os }}-build
          evict-old-files: 1d

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build cmake

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install ninja cmake

      - name: Configure
        run: |
          cmake --preset ci-release \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

      - name: Build
        run: cmake --build build/ci-release --parallel

      - name: Test
        run: ctest --test-dir build/ci-release --output-on-failure

  # ---------------------------------------------------------------------------
  # Cross-architecture builds via QEMU
  # ---------------------------------------------------------------------------
  build-cross-arch:
    name: Build (${{ matrix.arch }})
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.run_type == 'full'
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: linux/arm64
            cmake_flags: -DGGML_NATIVE=OFF
          - arch: linux/arm/v7
            cmake_flags: -DGGML_NATIVE=OFF

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Build ${{ matrix.arch }}
        run: |
          docker run --platform ${{ matrix.arch }} --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace ubuntu:22.04 /bin/sh -c '
            set -e
            export DEBIAN_FRONTEND=noninteractive
            apt-get update
            apt-get install -y build-essential cmake ninja-build git
            cmake -B build -G Ninja \
              -DCMAKE_BUILD_TYPE=Release \
              ${{ matrix.cmake_flags }}
            cmake --build build --parallel $(nproc)
            ctest --test-dir build --output-on-failure'

  # ---------------------------------------------------------------------------
  # Sanitizers
  # ---------------------------------------------------------------------------
  sanitizers:
    name: ${{ matrix.sanitizer }}
    if: |
      github.event_name != 'workflow_dispatch' ||
      github.event.inputs.run_type == 'full' ||
      github.event.inputs.run_type == 'sanitizers-only'
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - sanitizer: AddressSanitizer
            preset: asan
          - sanitizer: UndefinedBehaviorSanitizer
            preset: ubsan
          - sanitizer: ThreadSanitizer
            preset: tsan

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ubuntu-${{ matrix.preset }}
          evict-old-files: 1d

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build cmake

      - name: Configure
        run: |
          cmake --preset ${{ matrix.preset }} \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

      - name: Build
        run: cmake --build build/${{ matrix.preset }} --parallel

      - name: Test
        run: ctest --test-dir build/${{ matrix.preset }} --output-on-failure

  # ---------------------------------------------------------------------------
  # Static Analysis
  # ---------------------------------------------------------------------------
  static-analysis:
    name: ${{ matrix.tool }}
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - tool: clang-tidy
            preset: clang-tidy
            packages: clang-tidy
            build_target: ""
          - tool: cppcheck
            preset: cppcheck
            packages: cppcheck
            build_target: cppcheck

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build cmake ${{ matrix.packages }}

      - name: Configure
        run: cmake --preset ${{ matrix.tool }}

      - name: Run ${{ matrix.tool }}
        run: |
          if [ -n "${{ matrix.build_target }}" ]; then
            cmake --build build/${{ matrix.preset }} --target ${{ matrix.build_target }}
          else
            cmake --build build/${{ matrix.preset }} --parallel
          fi

  # ---------------------------------------------------------------------------
  # Windows Build
  # ---------------------------------------------------------------------------
  windows:
    name: Windows (${{ matrix.arch }})
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.run_type == 'full'
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [x64]
        build: [Release]

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Configure
        run: cmake -S . -B build -A ${{ matrix.arch }} -DCMAKE_BUILD_TYPE=${{ matrix.build }}

      - name: Build
        run: cmake --build build --config ${{ matrix.build }} --parallel

      - name: Test
        run: ctest --test-dir build -C ${{ matrix.build }} --output-on-failure